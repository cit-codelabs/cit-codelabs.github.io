
<!doctype html>

<html>
<head>
  <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">
  <meta name="theme-color" content="#4F7DC9">
  <meta charset="UTF-8">
  <title>GlobalJags Walkthrough</title>
  <link rel="icon" type="image/x-icon" href="/img/favicon.ico">
  <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Source+Code+Pro:400|Roboto:400,300,400italic,500,700|Roboto+Mono">
  <link rel="stylesheet" href="//fonts.googleapis.com/icon?family=Material+Icons">
  <link rel="stylesheet" href="https://storage.googleapis.com/claat-public/codelab-elements.css">
  <style>
    .success {
      color: #1e8e3e;
    }
    .error {
      color: red;
    }
  </style>
</head>
<body>
  <google-codelab-analytics gaid="UA-49880327-14"></google-codelab-analytics>
  <google-codelab codelab-gaid="UA-133580637-1"
                  id="globaljags-walkthrough"
                  title="GlobalJags Walkthrough"
                  environment="web"
                  feedback-link="mailto:elliott@iupui.edu">
    
      <google-codelab-step label="Introduction" duration="0">
        <table>
<tr><td colspan="1" rowspan="1"><p>You have been provided with starter code for the GlobalJags cloud-based application. Follow the instructions below to complete and deploy your own version of the project.</p>
</td><td colspan="1" rowspan="1"><p class="image-container"><img style="width: 252.00px" src="img/a3f391d3b41e2537.png"></p>
</td></tr>
</table>
<p><strong>Before you begin</strong> you MUST have an active Google Cloud Platform billing account. Your instructor previously shared the setup instructions for this account.</p>
<p>---</p>
<p>This tutorial is authored by Rob Elliott, Teaching Professor of Computer and Information Technology at IUPUI (<a href="mailto:elliott@iupui.edu" target="_blank">elliott@iupui.edu</a>).  The Codelab was created using the <a href="https://github.com/googlecodelabs/tools" target="_blank">Google Codelab export tools</a>.</p>


      </google-codelab-step>
    
      <google-codelab-step label="Overview" duration="0">
        <p>This project will integrate several cloud services together into a cohesive application. This application will use the Google Cloud Platform, but could easily be accomplished with similar services on other major cloud service providers.</p>
<h2 is-upgraded>System Request</h2>
<ol type="1" start="1">
<li>Create a website that displays a map &amp; allows users to upload photos from Study Abroad trips at IUPUI<br></li>
<li>Automatically create thumbnail images of the photo<br></li>
<li>If available, extract the location data from where the photo was taken<br></li>
<li>Show a thumbnail photo of each image on a Google Map at the location where it was taken</li>
</ol>
<h2 is-upgraded>Google Cloud Services Implemented</h2>
<ol type="1" start="1">
<li>Website will be created in Node.js and hosted on <strong>App Engine</strong></li>
<li>Two <strong>Cloud Functions</strong> will be created to manipulate and retrieve data from uploaded images<br></li>
<li>Data will be stored in the <strong>Firestore</strong> database, a NoSQL database that provides real-time updates<br></li>
<li>Photos uploaded to the service will be stored in <strong>Cloud Storage<br></strong></li>
<li>A <strong>Google Map</strong> will display the thumbnail images after they are processed</li>
</ol>


      </google-codelab-step>
    
      <google-codelab-step label="Step 1: Obtain the Starter Code" duration="0">
        <p>Visit the Google Cloud Platform Console by going to <a href="https://console.cloud.google.com" target="_blank">https://console.cloud.google.com</a>.</p>
<p><a href="https://console.cloud.google.com" target="_blank"><paper-button class="colored" raised>Open the Google Cloud Console</paper-button></a></p>
<p>Create a NEW Google Cloud Project with a unique name.</p>
<ul>
<li>Remember to start your Cloud Project name with a <strong>letter</strong> and <strong>not a number</strong></li>
</ul>
<h2 is-upgraded>Clone the Starter Code</h2>
<ol type="1" start="1">
<li>In a new tab, visit <a href="https://bit.ly/globaljags" target="_blank">https://bit.ly/globaljags</a></li>
<li>Log in with your IU username/passphrase (no Duo needed)</li>
<li>Create a new fork of the code</li>
</ol>
<ol type="1" start="1">
<li>UNCHECK the box that says &#34;Copy the &#39;starter&#39; branch only&#34;</li>
<li>Choose your IU username if asked for an owner</li>
<li>Click &#34;Create Fork&#34;</li>
<li>Copy the URL to your repository to use in the next step</li>
</ol>
<h2 is-upgraded>Download Your Copy of the Starter Code</h2>
<ol type="1" start="1">
<li>In another new tab, open Cloud Shell <a href="https://shell.cloud.google.com" target="_blank">https://shell.cloud.google.com</a></li>
<li>Log in with your Google@IU account</li>
<li>At the command line, clone your repository</li>
</ol>
<ol type="1" start="1">
<li>Enter your IU username and passphrase when asked</li>
</ol>
<pre>$ git clone YOUR-REPOSITORY-URL</pre>
<h2 is-upgraded>Preview the Website</h2>
<ol type="1" start="1">
<li>From the Cloud Shell command line, run the following:</li>
</ol>
<pre>$ cd globaljags-demo/web

$ npm install &amp;&amp; npm start</pre>
<ol type="1" start="2">
<li>Use the Cloud Shell web preview to view the site</li>
</ol>
<ol type="1" start="1">
<li>Port must be set to 8080</li>
</ol>
<h2 is-upgraded>Obtain the Sample Images</h2>
<p>Sample images with embedded EXIF location data have been provided for you to use in testing your application.<br></p>
<p><a href="https://bit.ly/globaljags-images" target="_blank"><paper-button class="colored" raised>View the Sample Images</paper-button></a></p>


      </google-codelab-step>
    
      <google-codelab-step label="Step 2: Configure Google Cloud Resources" duration="0">
        <h2 is-upgraded>Obtain a Google Maps API Key</h2>
<p>Visit the Google Cloud Console and ensure your GlobalJags project is active.</p>
<p><a href="https://console.cloud.google.com" target="_blank"><paper-button class="colored" raised>Open the Google Cloud Console</paper-button></a></p>
<ol type="1" start="1">
<li>Open the navigation menu at the top left (the &#34;hamburger&#34; menu)</li>
<li>Under <strong>&#34;More Products&#34;</strong> choose <strong>&#34;APIs &amp; Services&#34;</strong></li>
<li>Click <strong>&#34;Enable APIs and Services&#34;</strong></li>
<li>Search for or select <strong>&#34;Maps JavaScript API&#34;</strong></li>
<li>Choose <strong>&#34;Enable&#34;</strong></li>
<li>Copy the API Key labeled <strong>&#34;Your API Key&#34;</strong></li>
</ol>
<h2 is-upgraded>Create GCS Buckets</h2>
<p>Visit the Google Cloud Console and ensure your GlobalJags project is active.</p>
<p><a href="https://console.cloud.google.com" target="_blank"><paper-button class="colored" raised>Open the Google Cloud Console</paper-button></a></p>
<ol type="1" start="1">
<li>Open the navigation menu at the top left (the &#34;hamburger&#34; menu)</li>
<li>Under <strong>&#34;More Products&#34;</strong>, scroll to <strong>&#34;Storage&#34;</strong> and choose <strong>&#34;Cloud Storage&#34;</strong></li>
<li>Click <strong>&#34;Create&#34;</strong></li>
<li>Create THREE buckets that are globally, uniquely named for <em>uploads</em>, <em>thumbnails</em>, and <em>images </em>(see below)</li>
<li>Leave all other options at their default settings</li>
<li>Click <strong>&#34;Create&#34;</strong></li>
</ol>
<aside class="warning"><p><strong>Important!</strong>  Your bucket names must be completely unique across all GCP users.  One suggestion is to incorporate your username into the bucketname to assist in finding a globally unique name. Examples:</p>
<ul>
<li><em>username</em>-globaljags-uploads</li>
<li><em>username</em>-globaljags-thumbnails</li>
<li><em>username</em>-globaljags-images</li>
</ul>
</aside>
<h2 is-upgraded>Configure Access to Your GCS Buckets</h2>
<p>Visit the Google Cloud Console and ensure your GlobalJags project is active.</p>
<p><a href="https://console.cloud.google.com" target="_blank"><paper-button class="colored" raised>Open the Google Cloud Console</paper-button></a></p>
<ol type="1" start="1">
<li>Open the navigation menu at the top left (the &#34;hamburger&#34; menu)</li>
<li>Under <strong>&#34;More Products&#34;</strong>, scroll to <strong>&#34;Storage&#34;</strong> and choose <strong>&#34;Cloud Storage&#34;</strong></li>
<li>You should see the three buckets you created in the previous step</li>
</ol>
<ul>
<li>You may see additional buckets created by other build processes</li>
</ul>
<ol type="1" start="4">
<li>You need to make the assets in your <strong>thumbnails</strong> and <strong>images</strong> buckets public so that they can be viewed over the web</li>
</ol>
<p>Complete these steps for EACH bucket:</p>
<ol type="1" start="1">
<li>Click the &#34;three dot&#34; menu to the right of the bucket&#39;s name</li>
<li>Click <strong>&#34;Edit access&#34;</strong></li>
<li>Click <strong>&#34;REMOVE PUBLIC ACCESS PREVENTION&#34;</strong></li>
<li>A modal window will appear. Click <strong>&#34;CONFIRM&#34;</strong></li>
<li><strong><em>IMPORTANT: </em></strong><em>Refresh your entire browser tab that shows the list of your Cloud Storage buckets!!</em></li>
<li>Click the &#34;three dot&#34; menu to the right of the bucket&#39;s name</li>
<li>Click <strong>&#34;Edit access&#34;</strong></li>
<li>Click the <strong>&#34;ADD PRINCIPAL&#34;</strong> button</li>
<li>In the field labeled &#34;New principals&#34; enter <strong>allUsers</strong></li>
<li>In the &#34;Select a role&#34; dropdown, choose <strong>&#34;Cloud Storage&#34;</strong> and then <strong>&#34;Storage Object Viewer&#34;</strong></li>
<li>Click <strong>&#34;Save&#34;</strong></li>
<li>Another modal will appear. Click <strong>&#34;ALLOW PUBLIC ACCESS&#34;</strong></li>
</ol>
<h2 is-upgraded>Enable the App Engine API</h2>
<p>You will host your final web application on App Engine - a containerized website hosting service.</p>
<p>Visit the Google Cloud Console and ensure your GlobalJags project is active.</p>
<p><a href="https://console.cloud.google.com" target="_blank"><paper-button class="colored" raised>Open the Google Cloud Console</paper-button></a></p>
<ol type="1" start="1">
<li>Open the navigation menu at the top left (the &#34;hamburger&#34; menu)</li>
<li>Under <strong>&#34;More Products&#34;</strong>, scroll to <strong>&#34;Serverless&#34;</strong> and choose <strong>&#34;App Engine&#34;</strong></li>
<li>Click <strong>&#34;Create Application&#34;</strong></li>
<li>Leave the default region selected and click <strong>&#34;NEXT&#34;</strong></li>
<li>It will take a few minutes for your the API to be enabled</li>
<li>You do not need to add a configuration now. Click <strong>&#34;I&#39;LL DO THIS LATER&#34;</strong></li>
</ol>
<h2 is-upgraded>Create a Firestore Database</h2>
<p>Visit the Google Cloud Console and ensure your GlobalJags project is active.</p>
<p><a href="https://console.cloud.google.com" target="_blank"><paper-button class="colored" raised>Open the Google Cloud Console</paper-button></a></p>
<ol type="1" start="1">
<li>Open the navigation menu at the top left (the &#34;hamburger&#34; menu)</li>
<li>Under <strong>&#34;More Products&#34;</strong>, scroll to <strong>&#34;Databases&#34;</strong> and choose <strong>&#34;Firestore&#34;</strong></li>
<li>Your database must be in Native mode to send updates to the website. Choose <strong>&#34;Select Native Mode&#34;</strong></li>
<li>When asked to select a location, choose <strong>&#34;nam5 (United States)&#34;</strong></li>
</ol>
<h2 is-upgraded>Create a Firebase Project</h2>
<p>Visit the <strong>Firebase</strong> Cloud Console and ensure your GlobalJags project is active.</p>
<p><a href="https://console.firebase.google.com" target="_blank"><paper-button class="colored" raised>Open the Firebase Console</paper-button></a></p>
<ol type="1" start="1">
<li>Choose <strong>&#34;Add Project&#34;</strong></li>
<li>In the field labeled &#34;Enter your project name&#34;, select your <em>existing</em> Google Cloud Project</li>
</ol>
<ul>
<li>This will incorporate Firebase functionality into your existing project</li>
</ul>
<ol type="1" start="3">
<li>Click <strong>&#34;Continue&#34;</strong></li>
<li>A modal window will confirm your billing with Google Cloud. Click <strong>&#34;Confirm plan&#34; </strong>and then <strong>&#34;Continue&#34;</strong></li>
<li>Disable Google Analytics for the project and click <strong>&#34;Add Firebase&#34;</strong></li>
<li>When your project is ready, click <strong>&#34;Continue&#34;</strong></li>
<li>In the panel that says &#34;Get started by adding Firebase to your app&#34;, click the <strong>Web icon &lt;/&gt;</strong></li>
<li>Under &#34;Register app&#34;, provide an app nickname. You can enter <strong>&#34;GlobalJags&#34;</strong></li>
<li>Click <strong>&#34;Register app&#34;</strong></li>
<li>Under &#34;Add Firebase SDK&#34;, select <strong>&#34;Use a &lt;script&gt; tag&#34;</strong>. COPY this information and save it for later. You will need it when we write the front end of the website.</li>
</ol>
<h2 is-upgraded>Update your Firebase Rules</h2>
<p>Visit the <strong>Firebase</strong> Cloud Console and ensure your GlobalJags project is active.</p>
<p><a href="https://console.firebase.google.com" target="_blank"><paper-button class="colored" raised>Open the Firebase Console</paper-button></a></p>
<ol type="1" start="1">
<li>From the Project Overview screen left-hand navigation, click <strong>&#34;Build&#34;</strong> and then click <strong>&#34;Firestore Database&#34;</strong></li>
<li>In the top navigation, click <strong>&#34;Rules&#34;</strong></li>
<li>Update the existing rules so it matches the settings below</li>
<li>Click <strong>&#34;Publish&#34;</strong></li>
</ol>
<p><code>Firestore Database Rules</code></p>
<pre><code>rules_version = &#39;2&#39;;
service cloud.firestore {
  match /databases/{database}/documents {
    match /{document=**} {
      allow read: if true; 
      allow write: if false;
    }
  }
}</code></pre>
<p>This allows your website to read the documents in your database but only your Cloud Function can modify the database.</p>


      </google-codelab-step>
    
      <google-codelab-step label="Step 3: Write the Code for the Generate Thumbnail Cloud Function" duration="0">
        <p>In the Google Cloud Shell, navigate to the <code>gcf_generate_thumbnail</code> directory. </p>
<p>On the command line, install the packages you need to support the Cloud Function:</p>
<pre>$ npm install npm install @google-cloud/storage path fs-extra os sharp</pre>
<p>Open the directory in the file editor and then open <code>index.js</code>.</p>
<h2 is-upgraded>Import Node Packages</h2>
<p>Import the Node packages required for your function.</p>
<p><code>globaljags/gcf_generate_thumbnail/index.js</code></p>
<pre><code>// Import packages
const {Storage} = require(&#39;@google-cloud/storage&#39;);
const path = require(&#39;path&#39;);
const fs = require(&#39;fs-extra&#39;);
const os = require(&#39;os&#39;);
const sharp = require(&#39;sharp&#39;);</code></pre>
<h2 is-upgraded>Write the Entry Point Function</h2>
<p>Complete the logic of the entry point function. This is the function that will be run first when the Cloud Function is triggered.</p>
<p>Substitute your values in the code below where indicated. You created your storage buckets in Step 2: Create GCS Buckets.</p>
<ul>
<li><strong>GCS-THUMBNAILS-BUCKET </strong><em>This is the globally unique identifier for the bucket where the thumbnail photos will be uploaded</em></li>
<li><strong>GCS-IMAGES-BUCKET </strong><em>This is the globally unique identifier for the bucket where the full-resolution photos will be uploaded</em></li>
</ul>
<p><code>globaljags/generate_thumbnail/index.js</code></p>
<pre><code>// Entry point function
exports.generateThumbnail = async (file, context) =&gt; {
  const gcsFile = file;
  const storage = new Storage();
  const sourceBucket = storage.bucket(gcsFile.bucket);
  const thumbnailsBucket = storage.bucket(GCS-THUMBNAILS-BUCKET);
  const imagesBucket = storage.bucket(GCS-IMAGES-BUCKET);

  const version = process.env.K_REVISION;
  console.log(`Running Cloud Function version ${version}`);

  console.log(`File name: ${gcsFile.name}`);
  console.log(`Generation number: ${gcsFile.generation}`);
  console.log(`Content type: ${gcsFile.contentType}`);

  // Reject images that are not jpeg or png files
  let fileExtension = &#39;&#39;;
  let validFile = false;

  if (gcsFile.contentType === &#39;image/jpeg&#39;) {
    console.log(`Generation number: ${gcsFile.generation}`);
    console.log(`Content type: ${gcsFile.contentType}`);
    console.log(&#39;This is a JPEG file.&#39;);
    fileExtension = &#39;jpg&#39;;
    validFile = true;
  } else if (gcsFile.contentType === &#39;image/png&#39;) {
    console.log(`Generation number: ${gcsFile.generation}`);
    console.log(`Content type: ${gcsFile.contentType}`);
    console.log(&#39;This is a PNG file.&#39;);
    fileExtension = &#39;png&#39;;
    validFile = true;
  } else {
    console.log(`This is not a valid file type.`);
  }

  // If the file is a valid photograph, download it to the &#39;local&#39; VM so that we can create a thumbnail image
  if (validFile) {
    // Create a new filename for the &#39;final&#39; version of the image file
    // The value of this will be something like &#39;12745649237578595.jpg&#39;
    const finalFileName = `${gcsFile.generation}.${fileExtension}`;

    // Create a working directory on the VM that runs our GCF to download the original file
    // The value of this variable will be something like &#39;tmp/thumbs&#39;
    const workingDir = path.join(os.tmpdir(), &#39;thumbs&#39;);

    // Create a variable that holds the path to the &#39;local&#39; version of the file
    // The value of this will be something like &#39;tmp/thumbs/398575858493.png&#39;
    const tempFilePath = path.join(workingDir, finalFileName);
    console.log(`tempFilePath: ${tempFilePath}`);

    // Wait until the working directory is ready
    await fs.ensureDir(workingDir);
    console.log(`Working directory is ready.`);

    // Download the original file to the path on the &#39;local&#39; VM
    await sourceBucket.file(gcsFile.name).download({
      destination: tempFilePath
    });
    console.log(`File downloaded to the temp directory.`);

    // Upload our local version of the file to the final images bucket
    await imagesBucket.upload(tempFilePath);
    console.log(`File uploaded.`)

    // Create a name for the thumbnail image
    // The value for this will be something like `thumb@64_1234567891234567.jpg`
    const thumbName = `thumb@64_${finalFileName}`;

    // Create a path where we will store the thumbnail image locally
    // This will be something like `tmp/thumbs/thumb@64_1234567891234567.jpg`
    const thumbPath = path.join(workingDir, thumbName);
    console.log(`Thumb path: ${thumbPath}`);

    // Use the sharp library to generate the thumbnail image and save it to the thumbPath
    // Then upload the thumbnail to the thumbnailsBucket in cloud storage
    await sharp(tempFilePath).resize(64).withMetadata().toFile(thumbPath).then( async () =&gt; {
      console.log(`Resize complete: ${thumbName}`);
      await thumbnailsBucket.upload(thumbPath);
      console.log(`Upload complete: ${thumbName}`);
    });

    // Delete the temp working directory and its files from the GCF&#39;s VM
    await fs.remove(workingDir);
    console.log(`Deleted the working directory.`);
  } // end of validFile==true

  // DELETE the original file uploaded to the &#34;Uploads&#34; bucket
  await sourceBucket.file(gcsFile.name).delete();
  console.log(`Deleting uploaded file: ${gcsFile.name}`);
}


</code></pre>
<h2 is-upgraded>Deploy the Cloud Function</h2>
<p>Deploying the Cloud Function allows you to execute and test its logic. To deploy, you MUST know the values for the following variables. Substitute your values in the commands below.</p>
<ul>
<li><strong>GCP-PROJECT-NAME </strong><em>This is the name of your Google Cloud Project</em></li>
<li><strong>GCS-UPLOADS-BUCKET </strong><em>This is the globally unique identifier for the bucket where photos will be uploaded</em></li>
</ul>
<h3 is-upgraded>Ensure your Cloud Project is Active</h3>
<pre>$ gcloud config set project GCP-PROJECT-NAME</pre>
<p>If asked, click the button to Authorize access to your project from Cloud Shell.</p>
<h3 is-upgraded>Deploy the Cloud Function</h3>
<pre>$ gcloud functions deploy generate_thumbnail \
--entry-point generateThumbnail \
--runtime nodejs18 \
--trigger-bucket=GCS-UPLOADS-BUCKET</pre>
<p>If asked to enable the Cloud Functions and Cloud Build APIs, do so.</p>
<p>Deploying the function can take up to 3 minutes.</p>
<aside class="special"><p><strong>Pro Tip!</strong>  After you have deployed your Cloud Function the first time, you can redeploy with a shortened syntax. From the command line, simply type:</p>
<p><code>$ gcloud functions deploy generate_thumbnail</code></p>
</aside>


      </google-codelab-step>
    
      <google-codelab-step label="Step 4: Write the Code for the Extract EXIF Cloud Function" duration="0">
        <p>In the Google Cloud Shell, navigate to the <code>gcf_extract_exif</code> directory. </p>
<p>On the command line, install the packages you need to support the Cloud Function:</p>
<pre>$ npm install npm install @google-cloud/storage @google-cloud/firestore path fs-extra os exif-async parse-dms</pre>
<p>Open the directory in the file editor and then open <code>index.js</code>.</p>
<h2 is-upgraded>Import Node Packages</h2>
<p>Import the Node packages required for your function.</p>
<p><code>globaljags/gcf_extract_exif/index.js</code></p>
<pre><code>// Import packages
const {Storage} = require(&#39;@google-cloud/storage&#39;);
const {Firestore} = require(&#39;@google-cloud/firestore&#39;);
const path = require(&#39;path&#39;);
const fs = require(&#39;fs-extra&#39;);
const os = require(&#39;os&#39;);
const getExif = require(&#39;exif-async&#39;);
const parseDMS = require(&#39;parse-dms&#39;);
</code></pre>
<h2 is-upgraded>Write the Entry Point Function</h2>
<p>Complete the logic of the entry point function. This is the function that will be run first when the Cloud Function is triggered.</p>
<p>Substitute your values in the code below where indicated.</p>
<ul>
<li><strong>GCS-IMAGES-BUCKET </strong><em>This is the globally unique identifier for the bucket where the full-resolution photos were uploaded</em></li>
</ul>
<p><code>globaljags/gcf_extract_exif/index.js</code></p>
<pre><code>// Entry Point function
exports.extractExif = async (file, context) =&gt; {
  const gcsFile = file;
  const thumbnailFileName = gcsFile.name;
  const imageFileName = gcsFile.name.split(&#39;_&#39;)[1];
  const storage = new Storage();
  const firestore = new Firestore();
  const thumbnailsBucket = storage.bucket(gcsFile.bucket);
  const imagesBucket = storage.bucket(&#39;GCS-IMAGES-BUCKET&#39;);

  // This shows me which GCP version of the function is executing
  const version = process.env.K_REVISION;
  console.log(`Running Cloud Function version ${version}`);

  // Create a working directory on the VM that runs our GCF to download the original file
  // The value of this variable will be something like &#39;tmp/exif&#39;
  const workingDir = path.join(os.tmpdir(), &#39;exif&#39;);

  // Create a variable that holds the path to the &#39;local&#39; version of the file
  // The value of this will be something like &#39;tmp/exif/thumb@64_398575858493.png&#39;
  const tempFilePath = path.join(workingDir, thumbnailFileName);
  console.log(`tempFilePath: ${tempFilePath}`);

  // Wait until the working directory is ready
  await fs.ensureDir(workingDir);
  console.log(`Working directory is ready.`);

  // Download the original file to the path on the &#39;local&#39; VM
  await thumbnailsBucket.file(gcsFile.name).download({
    destination: tempFilePath
  });  

  // Ensure the file is downloaded to the &#39;local&#39; VM
  await fs.ensureFile(tempFilePath);
  console.log(`File downloaded: ${tempFilePath}`);

  // Pass the LOCAL file to our readExifData function
  // This will return an object with information about the CreateDate, latitude, and longitude of the photo
  const dataObject = await readExifData(tempFilePath);
  console.log(`The dataObject:`);
  console.log(dataObject);

  // Create variables that hold the HTTP URLs to the different versions of the photo
  let thumb64URL = `https://storage.googleapis.com/${thumbnailsBucket.name}/${thumbnailFileName}`
  let imageURL = `https://storage.googleapis.com/${imagesBucket.name}/${imageFileName}`

  // Update the dataObject to add links to the image
  dataObject.fileName = imageFileName;
  dataObject.image_url = imageURL;
  dataObject.thumb64_url = thumb64URL;
  console.log(dataObject);

  // Write the dataObject to a Firestore document
  let collectionRef = firestore.collection(&#39;photos&#39;);
  let documentRef = await collectionRef.add(dataObject);
  console.log(`Document created: ${documentRef.id}`);

  // Delete the temp working directory and its files from the GCF&#39;s VM
  await fs.remove(workingDir);
  console.log(`Deleted the working directory.`);
};

</code></pre>
<h2 is-upgraded>Write the Helper Function - readExifData</h2>
<p>Complete the logic of the first helper function. This function examines the local version of the file and reads the EXIF data embedded in it.</p>
<p><code>globaljags/gcf_extract_exif/index.js</code></p>
<pre><code>// Helper functions
async function readExifData(localFile) {
  // Use the exif-async package to read the EXIF data
  let exifData;
  try {
    exifData = await getExif(localFile);
    console.log(exifData.gps);

    // Create an object that will hold the pertinent EXIF elements
    let dataObject = {}
    dataObject.createDate = exifData.exif.CreateDate;

    // If EXIF data exists, add it to the dataObject
    if (Object.keys(exifData.gps).length &gt; 0){
      // Call helper function to convert GPS coordinates from DMS to decimal
      let gpsInDecimal = getGPSCoordinates(exifData.gps);
      console.log(gpsInDecimal);
      console.log(`Latitude: ${gpsInDecimal.lat}`);
      console.log(`Longitude: ${gpsInDecimal.lon}`);
      // Add latitude and longitude information to the dataObject
      dataObject.latitude = gpsInDecimal.lat;
      dataObject.longitude = gpsInDecimal.lon;
      // Return the dataObject to the calling function
      return dataObject;
    } else {
      // If there is no EXIF data, return the empty dataObject
      console.log(&#39;No GPS data was found in this photo.&#39;);
      return dataObject;
    }

  } catch(err) {
    console.log(`Error in readExifData function.`);
    console.log(err);
    return null;
  }
}</code></pre>
<h2 is-upgraded>Write the Helper Function - getGPSCoordinates</h2>
<p>Complete the logic of the second helper function. This function receives an object that contains a GPS location in DMS (&#34;degrees-minutes-seconds&#34;) format and converts it to decimal-based coordinates.</p>
<p><code>globaljags/gcf_extract_exif/index.js</code></p>
<pre><code>// Helper functions
function getGPSCoordinates(g) {
  // Parse DMS needs a string in the format of:
  // 51:30:0.5486N 0:7:34.4503W
  // DEG:MIN:SECDIRECTION DEG:MIN:SECDIRECTION
  // const g = exifData.gps;
  const latString = `${g.GPSLatitude[0]}:${g.GPSLatitude[1]}:${g.GPSLatitude[2]}${g.GPSLatitudeRef}`;
  const lonString = `${g.GPSLongitude[0]}:${g.GPSLongitude[1]}:${g.GPSLongitude[2]}${g.GPSLongitudeRef}`;

  // Use the parse-dms package to convert from DMS to decimal values
  degCoords = parseDMS(`${latString} ${lonString}`);

  // Return an object with the latitude and longitude in decimal
  return degCoords;
}</code></pre>
<h2 is-upgraded>Deploy the Cloud Function</h2>
<p>Deploying the Cloud Function allows you to execute and test its logic. To deploy, you MUST know the values for the following variables. Substitute your values in the commands below.</p>
<ul>
<li><strong>GCP-PROJECT-NAME </strong><em>This is the name of your Google Cloud Project</em></li>
<li><strong>GCS-THUMBNAILS-BUCKET </strong><em>This is the globally unique identifier for the bucket where thumbnail photos were uploaded</em></li>
</ul>
<h3 is-upgraded>Ensure your Cloud Project is Active</h3>
<pre>$ gcloud config set project GCP-PROJECT-NAME</pre>
<p>If asked, click the button to Authorize access to your project from Cloud Shell.</p>
<h3 is-upgraded>Deploy the Cloud Function</h3>
<pre>$ gcloud functions deploy extract_exif \
--entry-point extractExif \
--runtime nodejs18 \
--trigger-bucket=GCS-THUMBNAILS-BUCKET</pre>
<p>If asked to enable the Cloud Functions and Cloud Build APIs, do so.</p>
<p>Deploying the function can take up to 3 minutes.</p>
<aside class="special"><p><strong>Pro Tip!</strong>  After you have deployed your Cloud Function the first time, you can redeploy with a shortened syntax. From the command line, simply type:</p>
<p><code>$ gcloud functions deploy extract_exif</code></p>
</aside>


      </google-codelab-step>
    
      <google-codelab-step label="Step 5: Complete the Back End of the Website" duration="0">
        <p>In the Google Cloud Shell, navigate to the <code>web</code> directory. You can preview the starter website by entering <code>npm install && npm start</code> at the shell&#39;s command line. Press <code>Control+C</code> to stop the website script.</p>
<p>On the command line, install the packages you need to finish the back end of the website:</p>
<pre>$ npm install @google-cloud/storage multer express path</pre>
<p>Open the directory in the file editor and then open <code>app.js</code>.</p>
<h2 is-upgraded>Import Node Packages</h2>
<p>Import the Node packages required for your website.</p>
<p><code>globaljags/web/app.js</code></p>
<pre><code>// Import packages
const express = require(&#39;express&#39;);
const path = require(&#39;path&#39;);
const Multer = require(&#39;multer&#39;);
const {Storage} = require(&#39;@google-cloud/storage&#39;);</code></pre>
<h2 is-upgraded>Add Configuration for the Web Application</h2>
<p>Set the variables and configurations needed for your web application to run.</p>
<p>Substitute your values in the code below where indicated.</p>
<ul>
<li><strong>GCS-UPLOADS-BUCKET </strong><em>This is the globally unique identifier for the bucket where the full-resolution photos will be uploaded</em></li>
</ul>
<p><code>globaljags/web/app.js</code></p>
<pre><code>  // Set the port
  const port = 8080;

  // Create instances of necessary packages
  const app = express();
  const storage = new Storage();

  // Set the identifier for the GCS bucket where the file will be stored
  const bucket = storage.bucket(GCS-UPLOADS-BUCKET);

  // Configure an instance of multer
  const multer = Multer({
    storage: Multer.memoryStorage(),
    limits: {
      fileSize: 15 * 1024 * 1024
    }
  });

  // Middleware
  app.use(&#39;/js&#39;, express.static(__dirname + &#39;/public/js&#39;));
  app.use(&#39;/css&#39;, express.static(__dirname + &#39;/public/css&#39;));
  app.use(&#39;/images&#39;, express.static(__dirname + &#39;/public/images&#39;));</code></pre>
<h2 is-upgraded>Configure the &#34;/upload&#34; Route</h2>
<p>The &#34;/uploads&#34; route will be called when a user uploads a file through the web form. Add the logic that moves the uploaded file to the GCS &#34;uploads&#34; bucket.</p>
<p>The route uses the multer middleware to help configure and reference the file uploaded in the form. <strong>Be sure to add this middleware in the route&#39;s definition</strong> (line 1 in the code presented below).</p>
<p>Adding a file to the &#34;uploads&#34; bucket will trigger the Generate Thumbnail Cloud Function.</p>
<p><code>globaljags/web/app.js</code></p>
<pre><code>app.post(&#39;/upload&#39;, multer.single(&#39;file&#39;), (req, res) =&gt; {
  // Ensure a file was uploaded from the form
  // If not, respond with a simple message and return from this function
  if (!req.file) {
    //TODO: Create a better error handling method if a file is not uploaded
    res.status(400).send(&#39;No file uploaded.&#39;);
    return;
  }

  // Create a streaming target where the file will be stored in GCS
  const blob = bucket.file(req.file.originalname);

  // Begin streaming the file to GCS
  const blobStream = blob.createWriteStream();

  // When the file has uploaded, redirect the browser to the home page
  blobStream.on(&#39;finish&#39;, () =&gt; {
    const uploadedFile = `${bucket.name}/${blob.name}`;
    console.log(`File uploaded: ${uploadedFile}`);
    res.redirect(&#39;/&#39;);
  });

  // Close the stream
  blobStream.end(req.file.buffer);

});</code></pre>


      </google-codelab-step>
    
      <google-codelab-step label="Step 6: Complete the Front End of the Website" duration="0">
        <p>In the Google Cloud Shell, navigate to the <code>web</code> directory. You can preview the starter website by entering <code>npm install && npm start</code> at the shell&#39;s command line. Press <code>Control+C</code> to stop the website script.</p>
<aside class="special"><p><strong>Status Report!</strong>  If you have completed steps 1-5, your website now allows you to upload a file and store the file in the &#34;uploads&#34; bucket. This will trigger the Generate Thumbnails and Extract EXIF Cloud Functions. However, your Google Map will not yet display thumbnail images or recenter itself. We will add that functionality now.</p>
</aside>
<h2 is-upgraded>Configure your Google Maps API Key</h2>
<p>In the Google Cloud Shell, open the <code>globaljags</code> directory in your embedded cloud editor.</p>
<p>You need to edit the <code>globaljags/web/public/index.html</code> file to add your API key.</p>
<ol type="1" start="1">
<li>Find the code block denoted below</li>
<li>Highlight the text that states <strong>REPLACE_WITH_YOUR_KEY</strong></li>
<li>Paste your copied Google Maps API key</li>
</ol>
<p><code>globaljags/web/public/index.html</code></p>
<pre><code>&lt;!--- Add the API key for your Google Map --&gt;
&lt;script defer type=&#34;text/javascript&#34; src=&#34;https://maps.googleapis.com/maps/api/js?key=REPLACE_WITH_YOUR_KEY&amp;callback=initMap&#34;&gt;&lt;/script&gt;</code></pre>
<h2 is-upgraded>Add Your Web Application&#39;s Firebase Configuration</h2>
<p>In the Google Cloud Shell, open the <code>globaljags</code> directory in your embedded cloud editor.</p>
<p>You need to edit the <code>globaljags/web/public/index.html</code> file to add your Firebase Configuration. <em>You created this configuration in Step 2: Create a Firebase Project.</em></p>
<aside class="special"><p><strong>Need your configuration?</strong>  You can retrieve your configuration block in Firebase Console.</p>
<ol type="1" start="1">
<li>Go to the <a href="https://console.firebase.google.com/" target="_blank">Firebase Console</a></li>
<li>Select your Project</li>
<li>At the top of the Project Overview page, click the Web App just below the Project Name (it may be in a button labeled &#34;1 app&#34;) and click the <strong>Gear Icon</strong></li>
<li>Scroll down to <strong>&#34;Your apps&#34;</strong> and ensure your Web app is selected</li>
<li>Under <strong>&#34;SDK setup and configuration&#34;</strong> choose <strong>&#34;Config&#34;</strong></li>
<li>Copy the code block that appears</li>
</ol>
</aside>
<p><code>globaljags/web/public/index.html</code></p>
<pre><code>      // Paste your web app&#39;s Firebase configuration
      const firebaseConfig = {
        apiKey: &#34;xyz&#34;,
        authDomain: &#34;YOUR-APP.firebaseapp.com&#34;,
        projectId: &#34;YOUR-PROJECT-ID&#34;,
        storageBucket: &#34;YOUR-STORAGE-BUCKET&#34;,
        messagingSenderId: &#34;355052305707&#34;,
        appId: &#34;1:355052305707:web:6ab20703d45bc89830d96e&#34;
      };</code></pre>
<h2 is-upgraded>Initialize Firebase and Create Variables</h2>
<p>In the Google Cloud Shell, open the <code>globaljags</code> directory in your embedded cloud editor.</p>
<p>You need to edit the <code>globaljags/web/public/index.html</code> file to initialize Firebase and create the variables needed by your script.</p>
<p><code>globaljags/web/public/index.html</code></p>
<pre><code>      // Initialize Firebase
      const fbapp = initializeApp(firebaseConfig);

      // Access the Firestore database 
      const db = getFirestore(fbapp);

      // Create a query that selects all documents in the &#34;photos&#34; collection
      const photoQuery = query(collection(db, &#34;photos&#34;));

      // Create an array that will hold all the markers on the map
      let markersArray = [];</code></pre>
<h2 is-upgraded>Implement the Listener Function that Will Update the Map When the Database is Updated</h2>
<p>In the Google Cloud Shell, open the <code>globaljags</code> directory in your embedded cloud editor.</p>
<p>You need to edit the <code>globaljags/web/public/index.html</code> file to fully implement the listener function that watches the Firestore database snapshot. When the database is updated, this function will update the Google Map to display all of the existing thumbnails.</p>
<p><code>globaljags/web/public/index.html</code></p>
<pre><code>// Create a listener function that watches a snapshot based on a query
      const listener = onSnapshot(photoQuery, (querySnapshot) =&gt; {
        console.log(&#39;Database snapshot updated!&#39;);

        // Set the boundaries of the map
        const bounds = new google.maps.LatLngBounds();

        // Clear existing markers from the map
        markersArray.forEach((marker) =&gt; {
          console.log(&#39;Deleting marker!&#39;);
          marker.setMap(null);
        });

        // Check to see if there are any photos in the snapshot;
        // If not, center the map on IUPUI
        if (querySnapshot.empty) {
          const iupui = new google.maps.LatLng(39.7749968, -86.1794685);
          bounds.extend(iupui);
        };

        // Loop through the documents found in the snapshot
        querySnapshot.forEach((doc) =&gt; {
          const photoLat = doc.data().latitude;
          const photoLon = doc.data().longitude;

          // Create a new LatLng object with the photo&#39;s lat/lon
          const photoLatLng = { lat: photoLat, lng: photoLon};

          // Extend the map bounds to encompass this point
          const newLocation = new google.maps.LatLng(photoLat, photoLon);
          bounds.extend(newLocation);

          console.log(doc.data().thumb64_url);

          // Place the marker on the map using the thumbnail as the icon
          const marker = new google.maps.Marker({
            position: photoLatLng,
            map,
            icon: doc.data().thumb64_url
          });

          // Add the new marker to the array of markers
          markersArray.push(marker);
        });
          
        // When all of the markers have been added to the map, move and recenter
        map.fitBounds(bounds);
        map.panToBounds(bounds);
        if (map.zoom &gt; 15) {
          map.setZoom(15);
        }

      });</code></pre>


      </google-codelab-step>
    
      <google-codelab-step label="Step 7: Test Your Application" duration="0">
        <p>If you have completed Steps 1-6 above, your GlobalJags application is complete! You can now run the website locally on Cloud Shell, upload a photo, and watch your Google Map react as the photos are processed by your Cloud Functions.</p>
<p>In the Google Cloud Shell, navigate to the <code>web</code> directory. You can preview the starter website by entering <code>npm install && npm start</code> at the shell&#39;s command line. Press <code>Control+C</code> to stop the website script.</p>
<h2 is-upgraded>Resetting Your Application</h2>
<p>You can reset your web application at any time by following these steps:</p>
<p>Visit the Google Cloud Console and ensure your GlobalJags project is active.</p>
<p><a href="https://console.cloud.google.com" target="_blank"><paper-button class="colored" raised>Open the Google Cloud Console</paper-button></a></p>
<ol type="1" start="1">
<li>Open the navigation menu at the top left (the &#34;hamburger&#34; menu)</li>
<li>Under <strong>&#34;More Products&#34;</strong>, scroll to <strong>&#34;Databases&#34;</strong> and choose <strong>&#34;Firestore&#34;</strong></li>
<li>Click the &#34;three dots&#34; menu next to the <strong>&#34;photos&#34;</strong> collection and choose <strong>&#34;Delete collection&#34;</strong></li>
</ol>
<ol type="1" start="1">
<li>This will delete all records in your photos collection. The collection will be recreated when a new photo is uploaded.</li>
</ol>
<ol type="1" start="4">
<li>Open the navigation menu at the top left (the &#34;hamburger&#34; menu)</li>
<li>Under <strong>&#34;More Products&#34;</strong>, scroll to <strong>&#34;Storage&#34;</strong> and choose <strong>&#34;Cloud Storage&#34;</strong></li>
<li>Select your &#34;thumbnails&#34; bucket</li>
<li>Select all images and delete them</li>
<li>Return to your list of Cloud Storage buckets</li>
<li>Select your &#34;images&#34; bucket</li>
<li>Select all images and delete them</li>
</ol>


      </google-codelab-step>
    
      <google-codelab-step label="Step 8: Deploy Your Website" duration="0">
        <p>Once your application has been tested and works to your satisfaction, you can deploy the web application to App Engine. This will make your web application available to all users.</p>
<p>In the Google Cloud Shell, navigate to the <code>web</code> directory.</p>
<p>On the command line, create the App Engine configuration file.</p>
<pre>$ touch app.yaml</pre>
<p>Open the directory in the file editor and then open <code>app.yaml</code>.</p>
<h2 is-upgraded>Add App Engine Configuration</h2>
<p>Add the necessary configuration for App Engine</p>
<p><code>globaljags/web/app.yaml</code></p>
<pre><code>runtime: nodejs18</code></pre>
<h2 is-upgraded>Deploy the Website</h2>
<h3 is-upgraded>Ensure your Cloud Project is Active</h3>
<p>Use the command line interface to set the active project.</p>
<pre>$ gcloud config set project GCP-PROJECT-NAME</pre>
<p>If asked, click the button to Authorize access to your project from Cloud Shell.</p>
<h3 is-upgraded>Issue the Deploy Command</h3>
<p>Use the command line interface to deploy the website.</p>
<pre>$ gcloud app deploy</pre>
<p>If asked to enable the any cloud APIs, do so.</p>
<p>Once deployed, you can find the URL for your App Engine site in the App Engine dashboard in Google Cloud Console.</p>
<p><a href="https://console.cloud.google.com" target="_blank"><paper-button class="colored" raised>Open the Google Cloud Console</paper-button></a></p>


      </google-codelab-step>
    
      <google-codelab-step label="What&#39;s Next?" duration="0">
        <p>Congratulations!  You&#39;ve created a fully functional cloud application that makes use of several cloud services.</p>
<p>You can now begin to view system requests through the lens of decomposed services – considering which functionality can be provided by different cloud services, and how to combine and trigger those cloud services collaboratively.</p>


      </google-codelab-step>
    
  </google-codelab>

  <script src="https://storage.googleapis.com/claat-public/native-shim.js"></script>
  <script src="https://storage.googleapis.com/claat-public/custom-elements.min.js"></script>
  <script src="https://storage.googleapis.com/claat-public/prettify.js"></script>
  <script src="https://storage.googleapis.com/claat-public/codelab-elements.js"></script>
  <script src="//support.google.com/inapp/api.js"></script>

</body>
</html>
