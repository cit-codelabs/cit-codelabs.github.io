
<!doctype html>

<html>
<head>
  <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">
  <meta name="theme-color" content="#4F7DC9">
  <meta charset="UTF-8">
  <title>GlobalJags Walkthrough</title>
  <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Source+Code+Pro:400|Roboto:400,300,400italic,500,700|Roboto+Mono">
  <link rel="stylesheet" href="//fonts.googleapis.com/icon?family=Material+Icons">
  <link rel="stylesheet" href="https://storage.googleapis.com/claat-public/codelab-elements.css">
  <style>
    .success {
      color: #1e8e3e;
    }
    .error {
      color: red;
    }
  </style>
</head>
<body>
  <google-codelab-analytics gaid="UA-49880327-14"></google-codelab-analytics>
  <google-codelab codelab-gaid="UA-133580637-1"
                  id="globaljags-walkthrough"
                  title="GlobalJags Walkthrough"
                  environment="web"
                  feedback-link="mailto:elliott@iupui.edu">
    
      <google-codelab-step label="Introduction" duration="0">
        <table>
<tr><td colspan="1" rowspan="1"><p>You have been provided with starter code for the GlobalJags cloud-based application. Follow the instructions below to complete and deploy your own version of the project.</p>
</td><td colspan="1" rowspan="1"><p class="image-container"><img style="width: 186.50px" src="img/6f8630d0dac1826a.png"></p>
</td></tr>
</table>
<p><strong>Before you begin</strong> you MUST have an active Google Cloud Platform billing account. Your instructor previously shared the setup instructions for this account.</p>
<p>---</p>
<p>This tutorial is authored by Rob Elliott, Teaching Professor of Computer and Information Technology at IUPUI (<a href="mailto:elliott@iupui.edu" target="_blank">elliott@iupui.edu</a>).  The Codelab was created using the <a href="https://github.com/googlecodelabs/tools" target="_blank">Google Codelab export tools</a>.</p>


      </google-codelab-step>
    
      <google-codelab-step label="Overview" duration="0">
        <p>Google Cloud Functions are discrete</p>
<p>Cloud Functions are activated (or &#34;triggered&#34;) by a number of different events: HTTP requests, Pub/Sub notifications, or changes to Cloud Storage. The Cloud Functions in this tutorial will be activated by HTTP requests, which means they will respond when their URL is visited by a user via a web browser.</p>


      </google-codelab-step>
    
      <google-codelab-step label="Step 1: Review the Starter Code" duration="0">
        <p>Visit the Google Cloud Platform Console by going to <a href="https://console.cloud.google.com" target="_blank">https://console.cloud.google.com</a>.</p>
<p><a href="https://console.cloud.google.com" target="_blank"><paper-button class="colored" raised>Open the Google Cloud Console</paper-button></a></p>
<p>From the title bar at the top of the page, view the active project name.  If this is not the correct project, selecting the project name will open the project selection modal window.</p>
<p class="image-container"><img style="width: 624.00px" src="img/ed9ef8846f221215.png"></p>
<p>Choose (or create) a project into which you will create a Cloud Function.  You should be returned to the Console home page with the selected project displayed in the title bar.</p>


      </google-codelab-step>
    
      <google-codelab-step label="Step 2: Configure Google Cloud Resources" duration="0">
        <h2 is-upgraded>Obtain a Google Maps API Key</h2>
<p>Visit the Google Cloud Console and ensure your GlobalJags project is active.</p>
<p><a href="https://console.cloud.google.com" target="_blank"><paper-button class="colored" raised>Open the Google Cloud Console</paper-button></a></p>
<ol type="1" start="1">
<li>Open the navigation menu at the top left (the &#34;hamburger&#34; menu)</li>
<li>Under <strong>&#34;More Products&#34;</strong> choose <strong>&#34;APIs &amp; Services&#34;</strong></li>
<li>Click <strong>&#34;Enable APIs and Services&#34;</strong></li>
<li>Search for or select <strong>&#34;Maps JavaScript API&#34;</strong></li>
<li>Choose <strong>&#34;Enable&#34;</strong></li>
<li>Copy the API Key labeled <strong>&#34;Your API Key&#34;</strong></li>
</ol>
<h2 is-upgraded>Create GCS Buckets</h2>
<p>Visit the Google Cloud Console and ensure your GlobalJags project is active.</p>
<p><a href="https://console.cloud.google.com" target="_blank"><paper-button class="colored" raised>Open the Google Cloud Console</paper-button></a></p>
<ul>
<li>Open the navigation menu at the top left (the &#34;hamburger&#34; menu)</li>
<li>Under <strong>&#34;More Products&#34;</strong>, scroll to <strong>&#34;Storage&#34;</strong> and choose <strong>&#34;Cloud Storage&#34;</strong></li>
<li>Click <strong>&#34;Create&#34;</strong></li>
<li>Create THREE buckets that are globally, uniquely named for <em>uploads</em>, <em>thumbnails</em>, and <em>images </em>(see below)</li>
<li>Leave all other options at their default settings</li>
<li>Click <strong>&#34;Create&#34;</strong></li>
</ul>
<aside class="warning"><p><strong>Important!</strong>  Your bucket names must be completely unique across all GCP users.  One suggestion is to incorporate your username into the bucketname to assist in finding a globally unique name. Examples:</p>
<ul>
<li><em>username</em>-globaljags-uploads</li>
<li><em>username</em>-globaljags-thumbnails</li>
<li><em>username</em>-globaljags-images</li>
</ul>
</aside>
<h2 is-upgraded>Configure Access to Your GCS Buckets</h2>
<p>Visit the Google Cloud Console and ensure your GlobalJags project is active.</p>
<p><a href="https://console.cloud.google.com" target="_blank"><paper-button class="colored" raised>Open the Google Cloud Console</paper-button></a></p>
<ul>
<li>Open the navigation menu at the top left (the &#34;hamburger&#34; menu)</li>
<li>Under <strong>&#34;More Products&#34;</strong>, scroll to <strong>&#34;Storage&#34;</strong> and choose <strong>&#34;Cloud Storage&#34;</strong></li>
<li>You should see the three buckets you created in the previous step</li>
<li>You may see additional buckets created by other build processes</li>
<li>You need to make the assets in your <strong>thumbnails</strong> and <strong>images</strong> buckets public so that they can be viewed over the web</li>
</ul>
<p>Complete these steps for EACH bucket:</p>
<ul>
<li>Click the &#34;three dot&#34; menu to the right of the bucket&#39;s name</li>
<li>Click <strong>&#34;Edit access&#34;</strong></li>
<li>Click <strong>&#34;REMOVE PUBLIC ACCESS PREVENTION&#34;</strong></li>
<li>A modal window will appear. Click <strong>&#34;CONFIRM&#34;</strong></li>
<li><strong><em>IMPORTANT: </em></strong><em>Refresh your entire browser tab that shows the list of your Cloud Storage buckets!!</em></li>
<li>Click the &#34;three dot&#34; menu to the right of the bucket&#39;s name</li>
<li>Click <strong>&#34;Edit access&#34;</strong></li>
<li>Click the <strong>&#34;ADD PRINCIPAL&#34;</strong> button</li>
<li>In the field labeled &#34;New principals&#34; enter <strong>allUsers</strong></li>
<li>In the &#34;Select a role&#34; dropdown, choose <strong>&#34;Cloud Storage&#34;</strong> and then <strong>&#34;Storage Object Viewer&#34;</strong></li>
<li>Click <strong>&#34;Save&#34;</strong></li>
<li>Another modal will appear. Click <strong>&#34;ALLOW PUBLIC ACCESS&#34;</strong></li>
</ul>
<h2 is-upgraded>Create a Firestore Database</h2>
<p>Visit the Google Cloud Console and ensure your GlobalJags project is active.</p>
<p><a href="https://console.cloud.google.com" target="_blank"><paper-button class="colored" raised>Open the Google Cloud Console</paper-button></a></p>
<ul>
<li>Open the navigation menu at the top left (the &#34;hamburger&#34; menu)</li>
<li>Under <strong>&#34;More Products&#34;</strong>, scroll to <strong>&#34;Databases&#34;</strong> and choose <strong>&#34;Firestore&#34;</strong></li>
<li>Your database must be in Native mode to send updates to the website. Choose <strong>&#34;Select Native Mode&#34;</strong></li>
<li>When asked to select a location, choose <strong>&#34;nam5 (United States)&#34;</strong></li>
</ul>
<h2 is-upgraded>Create a Firebase Project</h2>
<p>Visit the <strong>Firebase</strong> Cloud Console and ensure your GlobalJags project is active.</p>
<p><a href="https://console.firebase.google.com" target="_blank"><paper-button class="colored" raised>Open the Firebase Console</paper-button></a></p>
<ul>
<li>Choose <strong>&#34;Add Project&#34;</strong></li>
<li>In the field labeled &#34;Enter your project name&#34;, select your <em>existing</em> Google Cloud Project</li>
<li>This will incorporate Firebase functionality into your existing project</li>
<li>Click <strong>&#34;Continue&#34;</strong></li>
<li>A modal window will confirm your billing with Google Cloud. Click <strong>&#34;Confirm plan&#34; </strong>and then <strong>&#34;Continue&#34;</strong></li>
<li>Disable Google Analytics for the project and click <strong>&#34;Add Firebase&#34;</strong></li>
<li>When your project is ready, click <strong>&#34;Continue&#34;</strong></li>
<li>In the panel that says &#34;Get started by adding Firebase to your app&#34;, click the <strong>Web icon &lt;/&gt;</strong></li>
<li>Under &#34;Register app&#34;, provide an app nickname. You can enter <strong>&#34;GlobalJags&#34;</strong></li>
<li>Click <strong>&#34;Register app&#34;</strong></li>
<li>Under &#34;Add Firebase SDK&#34;, select <strong>&#34;Use a &lt;script&gt; tag&#34;</strong>. COPY this information and save it for later. You will need it when we write the front end of the website.</li>
</ul>
<h2 is-upgraded>Update your Firebase Rules</h2>
<p>Visit the <strong>Firebase</strong> Cloud Console and ensure your GlobalJags project is active.</p>
<p><a href="https://console.firebase.google.com" target="_blank"><paper-button class="colored" raised>Open the Firebase Console</paper-button></a></p>
<ul>
<li>From the Project Overview screen left-hand navigation, click <strong>&#34;Build&#34;</strong> and then click <strong>&#34;Firestore Database&#34;</strong></li>
<li>In the top navigation, click <strong>&#34;Rules&#34;</strong></li>
<li>Update the existing rules so it matches the settings below</li>
<li>Click <strong>&#34;Publish&#34;</strong></li>
</ul>
<p><code>Firestore Database Rules</code></p>
<pre><code>rules_version = &#39;2&#39;;
service cloud.firestore {
  match /databases/{database}/documents {
    match /{document=**} {
      allow read: if true; 
      allow write: if false;
    }
  }
}</code></pre>
<p>This allows your website to read the documents in your database but only your Cloud Function can modify the database.</p>


      </google-codelab-step>
    
      <google-codelab-step label="Step 3: Write the Code for the Generate Thumbnail Cloud Function" duration="0">
        <p>In the Google Cloud Shell, navigate to the <code>gcf_generate_thumbnail</code> directory. </p>
<p>On the command line, install the packages you need to support the Cloud Function:</p>
<pre>$ npm install npm install @google-cloud/storage path fs-extra os sharp</pre>
<p>Open the directory in the file editor and then open <code>index.js</code>.</p>
<h2 is-upgraded>Import Node Packages</h2>
<p>Import the Node packages required for your function.</p>
<p><code>globaljags/gcf_generate_thumbnail/index.js</code></p>
<pre><code>// Import packages
const {Storage} = require(&#39;@google-cloud/storage&#39;);
const path = require(&#39;path&#39;);
const fs = require(&#39;fs-extra&#39;);
const os = require(&#39;os&#39;);
const sharp = require(&#39;sharp&#39;);</code></pre>
<h2 is-upgraded>Deploy the Cloud Function</h2>
<p>Deploying the Cloud Function allows you to execute and test its logic. To deploy, you MUST know the values for the following variables. Substitute your values in the commands below.</p>
<ul>
<li><strong>GCP-PROJECT-NAME </strong><em>This is the name of your Google Cloud Project</em></li>
<li><strong>GCS-UPLOADS-BUCKET </strong><em>This is the globally unique identifier for the bucket where photos will be uploaded</em></li>
</ul>
<h3 is-upgraded>Ensure your Cloud Project is Active</h3>
<pre>$ gcloud config set project GCP-PROJECT-NAME</pre>
<p>If asked, click the button to Authorize access to your project from Cloud Shell.</p>
<h3 is-upgraded>Deploy the Cloud Function</h3>
<pre>$ gcloud functions deploy generate_thumbnail \
--entry-point generateThumbnail \
--runtime nodejs18 \
--trigger-bucket=GCS-UPLOADS-BUCKET</pre>
<p>If asked to enable the Cloud Functions and Cloud Build APIs, do so.</p>
<p>Deploying the function can take up to 3 minutes.</p>
<aside class="special"><p><strong>Pro Tip!</strong>  After you have deployed your Cloud Function the first time, you can redeploy with a shortened syntax. From the command line, simply type:</p>
<p><code>$ gcloud functions deploy generate_thumbnail</code></p>
</aside>


      </google-codelab-step>
    
      <google-codelab-step label="Step 3: Write the Code for the Extract EXIF Cloud Function" duration="0">
        <p>In the Google Cloud Shell, navigate to the <code>gcf_extract_exif</code> directory. </p>
<p>On the command line, install the packages you need to support the Cloud Function:</p>
<pre>$ npm install npm install @google-cloud/storage @google-cloud/firestore path fs-extra os exif-async parse-dms</pre>
<p>Open the directory in the file editor and then open <code>index.js</code>.</p>
<h2 is-upgraded>Import Node Packages</h2>
<p>Import the Node packages required for your function.</p>
<p><code>globaljags/gcf_extract_exif/index.js</code></p>
<pre><code>// Import packages
const {Storage} = require(&#39;@google-cloud/storage&#39;);
const {Firestore} = require(&#39;@google-cloud/firestore&#39;);
const path = require(&#39;path&#39;);
const fs = require(&#39;fs-extra&#39;);
const os = require(&#39;os&#39;);
const getExif = require(&#39;exif-async&#39;);
const parseDMS = require(&#39;parse-dms&#39;);
</code></pre>
<h2 is-upgraded>Write the Entry Point Function</h2>
<p>Complete the logic of the entry point function. This is the function that will be run first when the Cloud Function is triggered.</p>
<p>Substitute your values in the code below where indicated.</p>
<ul>
<li><strong>YOUR-IMAGES-BUCKET </strong><em>This is the globally unique identifier for the bucket where the full-resolution photos were uploaded</em></li>
</ul>
<p><code>globaljags/gcf_extract_exif/index.js</code></p>
<pre><code>// Entry Point function
exports.extractExif = async (file, context) =&gt; {
  const gcsFile = file;
  const thumbnailFileName = gcsFile.name;
  const imageFileName = gcsFile.name.split(&#39;_&#39;)[1];
  const storage = new Storage();
  const firestore = new Firestore();
  const thumbnailsBucket = storage.bucket(gcsFile.bucket);
  const imagesBucket = storage.bucket(&#39;YOUR-IMAGES-BUCKET&#39;);

  // This shows me which GCP version of the function is executing
  const version = process.env.K_REVISION;
  console.log(`Running Cloud Function version ${version}`);

  // Create a working directory on the VM that runs our GCF to download the original file
  // The value of this variable will be something like &#39;tmp/exif&#39;
  const workingDir = path.join(os.tmpdir(), &#39;exif&#39;);

  // Create a variable that holds the path to the &#39;local&#39; version of the file
  // The value of this will be something like &#39;tmp/exif/thumb@64_398575858493.png&#39;
  const tempFilePath = path.join(workingDir, thumbnailFileName);
  console.log(`tempFilePath: ${tempFilePath}`);

  // Wait until the working directory is ready
  await fs.ensureDir(workingDir);
  console.log(`Working directory is ready.`);

  // Download the original file to the path on the &#39;local&#39; VM
  await thumbnailsBucket.file(gcsFile.name).download({
    destination: tempFilePath
  });  

  // Ensure the file is downloaded to the &#39;local&#39; VM
  await fs.ensureFile(tempFilePath);
  console.log(`File downloaded: ${tempFilePath}`);

  // Pass the LOCAL file to our readExifData function
  // This will return an object with information about the CreateDate, latitude, and longitude of the photo
  const dataObject = await readExifData(tempFilePath);
  console.log(`The dataObject:`);
  console.log(dataObject);

  // Create variables that hold the HTTP URLs to the different versions of the photo
  let thumb64URL = `https://storage.googleapis.com/${thumbnailsBucket.name}/${thumbnailFileName}`
  let imageURL = `https://storage.googleapis.com/${imagesBucket.name}/${imageFileName}`

  // Update the dataObject to add links to the image
  dataObject.fileName = imageFileName;
  dataObject.image_url = imageURL;
  dataObject.thumb64_url = thumb64URL;
  console.log(dataObject);

  // Write the dataObject to a Firestore document
  let collectionRef = firestore.collection(&#39;photos&#39;);
  let documentRef = await collectionRef.add(dataObject);
  console.log(`Document created: ${documentRef.id}`);

  // Delete the temp working directory and its files from the GCF&#39;s VM
  await fs.remove(workingDir);
  console.log(`Deleted the working directory.`);
};

</code></pre>
<h2 is-upgraded>Deploy the Cloud Function</h2>
<p>Deploying the Cloud Function allows you to execute and test its logic. To deploy, you MUST know the values for the following variables. Substitute your values in the commands below.</p>
<ul>
<li><strong>GCP-PROJECT-NAME </strong><em>This is the name of your Google Cloud Project</em></li>
<li><strong>GCS-THUMBNAILS-BUCKET </strong><em>This is the globally unique identifier for the bucket where thumbnail photos were uploaded</em></li>
</ul>
<h3 is-upgraded>Ensure your Cloud Project is Active</h3>
<pre>$ gcloud config set project GCP-PROJECT-NAME</pre>
<p>If asked, click the button to Authorize access to your project from Cloud Shell.</p>
<h3 is-upgraded>Deploy the Cloud Function</h3>
<pre>$ gcloud functions deploy extract_exif \
--entry-point extractExif \
--runtime nodejs18 \
--trigger-bucket=GCS-THUMBNAILS-BUCKET</pre>
<p>If asked to enable the Cloud Functions and Cloud Build APIs, do so.</p>
<p>Deploying the function can take up to 3 minutes.</p>
<aside class="special"><p><strong>Pro Tip!</strong>  After you have deployed your Cloud Function the first time, you can redeploy with a shortened syntax. From the command line, simply type:</p>
<p><code>$ gcloud functions deploy extract_exif</code></p>
</aside>


      </google-codelab-step>
    
      <google-codelab-step label="Step 4: Complete the Back End of the Website" duration="0">
        <p>In the Google Cloud Shell, navigate to the <code>web</code> directory. You can preview the starter website by entering <code>npm install && npm start</code> at the shell&#39;s command line. Press <code>Control+C</code> to stop the website script.</p>
<p>On the command line, install the packages you need to finish the back end of the website:</p>
<pre>$ npm install @google-cloud/storage multer</pre>
<p>Open the directory in the file editor and then open <code>app.js</code>.</p>
<h2 is-upgraded>Import Node Packages</h2>
<p>Import the Node packages required for your website.</p>
<p><code>globaljags/web/app.js</code></p>
<pre><code>// Import packages
const {Storage} = require(&#39;@google-cloud/storage&#39;);
const {Firestore} = require(&#39;@google-cloud/firestore&#39;);
const path = require(&#39;path&#39;);
const fs = require(&#39;fs-extra&#39;);
const os = require(&#39;os&#39;);
const sharp = require(&#39;sharp&#39;);
const getExif = require(&#39;exif-async&#39;);
const parseDMS = require(&#39;parse-dms&#39;);</code></pre>


      </google-codelab-step>
    
      <google-codelab-step label="Step 5: Complete the Front End of the Website" duration="0">
        <p>In the Google Cloud Shell, navigate to the <code>web</code> directory. You can preview the starter website by entering <code>npm install && npm start</code> at the shell&#39;s command line. Press <code>Control+C</code> to stop the website script.</p>
<p><code>globaljags/web/public/index.html</code></p>
<pre><code>def hello_world(request):
    &#34;&#34;&#34;Responds to any HTTP request.
    Args:
        request (flask.Request): HTTP request object.
    Returns:
        The response text or any set of values that can be turned into a
        Response object using
        `make_response &lt;http://flask.pocoo.org/docs/1.0/api/#flask.Flask.make_response&gt;`.
    &#34;&#34;&#34;
    request_json = request.get_json()
    if request.args and &#39;message&#39; in request.args:
        return request.args.get(&#39;message&#39;)
    elif request_json and &#39;message&#39; in request_json:
        return request_json[&#39;message&#39;]
    else:
        return f&#39;Hello World!&#39;</code></pre>
<p>In the Google Cloud Shell, open the <code>globaljags</code> directory in your embedded cloud editor.</p>
<p>You need to edit the <code>globaljags/web/public/index.html</code> file to add your API key.</p>
<ol type="1" start="1">
<li>Find the code block denoted below</li>
<li>Highlight the text that states <strong>REPLACE_WITH_YOUR_KEY</strong></li>
<li>Paste your copied Google Maps API key</li>
</ol>
<p><code>globaljags/web/public/index.html</code></p>
<pre><code>&lt;!--- Add the API key for your Google Map --&gt;
&lt;script defer type=&#34;text/javascript&#34; src=&#34;https://maps.googleapis.com/maps/api/js?key=REPLACE_WITH_YOUR_KEY&amp;callback=initMap&#34;&gt;&lt;/script&gt;
</code></pre>


      </google-codelab-step>
    
      <google-codelab-step label="What&#39;s Next?" duration="0">
        <p>Congratulations!  You&#39;ve created two Google Cloud Functions.</p>
<p>The Pirate Name Generator could use some work.  Consider making any (or all) of the following improvements:</p>
<ul>
<li>Add error handling to ensure that all of the values in the querystring begin with alphabetic characters (including a numeric querystring value will cause an error.)</li>
<li>Adjust the code to allow just a first and last name.  If no middle name is provided, use the first letter of the first name, the last letter of the first name, and the first letter of the last name.</li>
<li>Update the responses from the cloud function to sound more pirate-y!</li>
</ul>
<p>Whatever you do to improve this cloud function, you now have the ability to write programs that can accomplish countless tasks.  You can perform calculations, rename files, send notifications or emails, query data sources - the list is virtually endless.</p>
<h2 is-upgraded>Integration with Other Cloud Functionality</h2>
<p>Cloud Functions are most powerful when combined with other cloud technologies.  If you&#39;re new to cloud development a good place to continue your journey is to explore the possibilities of <a href="https://cloud.google.com/storage" target="_blank">Google Cloud Storage</a>.  Cloud Functions can be invoked by changes to Cloud Storage buckets, so you can write a program that alerts you when a new file is uploaded, for example.</p>
<p>For a bit more advanced functionality, consider reading more about <a href="https://cloud.google.com/pubsub" target="_blank">Google Cloud Pub/Sub</a>, which is a service that allows other services to communicate on-demand.  A simple example of this might be to send messages to a chat application.  More powerful processes include data processing and validation, push notifications, and traffic analysis.</p>


      </google-codelab-step>
    
  </google-codelab>

  <script src="https://storage.googleapis.com/claat-public/native-shim.js"></script>
  <script src="https://storage.googleapis.com/claat-public/custom-elements.min.js"></script>
  <script src="https://storage.googleapis.com/claat-public/prettify.js"></script>
  <script src="https://storage.googleapis.com/claat-public/codelab-elements.js"></script>
  <script src="//support.google.com/inapp/api.js"></script>

</body>
</html>
